---
description: 通过最多 5 个高度针对性的澄清问题，识别视频项目规格中未明确的领域，并将答案编码回规格文档
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --paths-only
  ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

# /clarify 命令 - 规格澄清

用户输入可以直接由 AI 助手提供，也可以作为命令参数 - 在继续之前，你**必须**考虑它（如果不为空）。

用户输入：

$ARGUMENTS

## 目标

检测并减少活动视频项目规格中的模糊性或缺失的决策点，并将澄清内容直接记录在规格文件中。

## 重要说明

此澄清工作流程应该在调用 `/plan` **之前**运行（并完成）。如果用户明确表示跳过澄清（例如，探索性尝试），你可以继续，但必须警告下游返工风险会显著增加（**60-80% 成本浪费**，根据 Constitution 记录）。

## 执行步骤

### 1. 运行前置检查脚本

从仓库根目录运行 `{SCRIPT}` **一次**（组合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 负载字段：
- `FEATURE_DIR`
- `FEATURE_SPEC`
- （可选）捕获 `IMPL_PLAN`, `TASKS` 用于未来链式流程

如果 JSON 解析失败，中止并指示用户重新运行 `/specify` 或验证功能分支环境。

### 2. 执行结构化模糊度扫描

加载当前规格文件。使用以下**视频生成专属分类体系**执行结构化模糊度和覆盖度扫描。对于每个类别，标记状态：明确 / 部分 / 缺失。生成内部覆盖度图用于优先级排序（除非没有问题要问，否则不输出原始图）。

#### 视频生成覆盖度分类体系（10 个维度）

**1. 视觉风格与美术方向**
- 艺术风格清晰度（写实/动画/Q版 是否明确定义）
- 色彩调性具体性（暖色调/冷色调/去饱和 是否有可衡量目标）
- 视觉参考完整性（参考作品、艺术家、示例是否充分）
- 构图规则定义（三分法/中心构图/对称 是否明确）

**2. 角色设计与一致性**
- 角色外观完整性（年龄、性别、身体特征、服装是否详细）
- 跨场景一致性策略（是否选择 13图融合/提示词固定/参考图方案）
- 显著特征文档化（发型、配饰、特殊标记是否记录）
- 角色素材库规划（是否需要 character-asset-library.json）
- 角色情绪弧线（6 个场景中的情绪变化是否定义）

**3. 场景描述与环境**
- 三层画面结构（**每个**场景是否有前景-中景-背景）
- 环境氛围清晰度（情绪、时间、天气是否明确）
- 空间关系定义（物体位置、距离是否清楚）
- 场景过渡逻辑（场景如何视觉连接）

**4. 叙事结构与情绪弧线**
- 6场景叙事逻辑（是否选择 三幕结构/Save the Cat/情绪弧线）
- 每场景情绪起点/终点（情绪单元是否清晰）
- 场景过渡流畅性（场景间情绪流动是否自然）
- 整体故事节拍对齐（开端→冲突→解决 是否一致）

**5. 镜头语言与构图**
- 镜头类型选择（特写/中景/远景 分布是否合理）
- 相机运动需求（推/拉/摇/移/跟/固定 是否定义）
- 构图风格一致性（稳定/运动/手持/电影感 是否统一）
- 逐帧控制需求（是否需要首尾帧控制，适用于支持此功能的平台）

**6. 光照与色彩**
- 光照风格一致性（自然光/影棚光/戏剧性光照 是否统一）
- 时间/地点逻辑（昼夜进程是否合理）
- 情绪-氛围对齐（光照是否支持情绪基调）
- 色彩连贯性规则（同地点 = 同光照/色彩 是否遵循）

**7. 音频与对话**
- 对话/旁白需求（密度、语言、风格是否明确）
- 唇形同步需求（是否需要，影响平台选择）
- 音乐风格选择（电子/古典/流行/民族 是否确定）
- 音频混音优先级（音乐-对话-音效 权重比例是否定义）

**8. 平台适配与技术约束**
- 目标平台选择（抖音/视频号/快手/通用 是否明确）
- 平台特定格式（宽高比、分辨率、时长 是否符合）
- 平台能力对齐（唇形同步/相机控制/首尾帧 能力是否匹配）
- 提示词风格适配（Sora2 的 ai-optimized vs 即梦AI 的详细中文 是否对应）

**9. 预算与成本控制**
- 总预算范围（最小和最大值是否明确）
- 质量 vs 成本权衡偏好（质量优先/成本优先/平衡 是否选择）
- Phase 选择理由（Phase 0/1/2/4 是否需要或跳过，理由是否充分）
- 验证策略（L0 → L1 wireframe/full → L2? → L3 路径是否合理）

**10. 边缘情况与合规性**
- 内容合规要求（平台审核规则是否考虑）
- 版权风险缓解（音乐、图片、角色参考 是否有风险）
- 负面场景（平台拒绝怎么办、生成失败怎么办）
- 备用平台策略（主平台失败 → 切换到哪个备用平台）

对于状态为"部分"或"缺失"的类别，添加候选问题机会，除非：
- 澄清不会实质性改变实施或验证策略
- 信息更适合推迟到规划阶段（内部记录）

### 3. 生成优先级问题队列

（内部）生成优先级排序的候选澄清问题队列（**最多 5 个**）。**不要**一次性输出所有问题。应用以下约束：
- 整个会话最多 **5 个**问题
- 每个问题必须可以用以下**两种方式之一**回答：
  * 简短的多选题（2-5 个不同、互斥的选项），**或**
  * 一个单词/短语答案（明确限制："≤5 个字回答"）
- 只包含答案会实质性影响以下方面的问题：
  * 平台选择（Sora2 vs 即梦AI vs Runway）
  * 提示词风格（ai-optimized vs 详细中文 vs 简洁+数值）
  * 角色一致性策略（13图融合 vs 参考图）
  * Phase 选择（Phase 0 关键帧设计 或 跳过）
  * 验证级别（L1 wireframe vs full，L2 需要 或 跳过）
  * 预算分配（优先哪些 Phase）
  * 视觉/叙事质量（三层结构合规性、情绪弧线连贯性）
- 确保类别覆盖平衡：优先覆盖最高影响的未解决类别；避免在单个高影响领域（如平台选择、角色一致性）未解决时问两个低影响问题
- 排除已回答的问题、琐碎的风格偏好或计划级执行细节（除非阻碍正确性）
- 优先澄清可降低下游返工风险的问题（Constitution 中记录的 60-80% 成本节省）
- 如果超过 5 个类别仍未解决，按 **(影响 × 不确定性)** 启发式选择前 5 个

### 4. 顺序提问循环（交互式）

- 每次呈现**恰好一个**问题
- 对于多选题，以 Markdown 表格形式呈现选项：

  | 选项 | 描述 |
  |------|------|
  | A | <选项 A 描述> |
  | B | <选项 B 描述> |
  | C | <选项 C 描述> | （根据需要添加 D/E，最多 5 个）
  | 其他 | 提供不同的简短答案（≤5个字） | （仅在允许自由格式替代时包含）

- 对于短答案风格（没有有意义的离散选项），在问题后输出单行：`格式：短答案（≤5个字）`
- 用户回答后：
  * 验证答案映射到一个选项或符合 ≤5个字约束
  * 如果模糊，要求快速消歧（计数仍属于同一问题；不前进）
  * 一旦满意，记录在工作内存中（尚未写入磁盘）并移至下一个排队问题
- 停止提问的条件：
  * 所有关键模糊性提前解决（剩余排队项目变得不必要），**或**
  * 用户发出完成信号（"完成"、"好的"、"不再有"），**或**
  * 达到 5 个已问问题
- 永远不要提前透露未来排队的问题
- 如果开始时没有有效问题，立即报告没有关键模糊性

### 5. 每个接受答案后立即集成（增量更新方法）

- 维护规格的内存表示（开始时加载一次）加上原始文件内容
- 对于本次会话中的第一个集成答案：
  * 确保存在 `## Clarifications` 部分（如果缺失，在 `## Creative Brief` 部分之后创建）
  * 在其下，为今天创建（如果不存在）`### Session YYYY-MM-DD` 子标题
- 接受后立即追加项目符号行：`- Q: <问题> → A: <最终答案>`
- 然后立即将澄清应用到最合适的部分：
  * 视觉风格模糊 → 更新 `## Visual Style Requirements` 添加具体细节
  * 角色设计 → 更新 `## Character Assets` 添加外观/一致性细节
  * 场景描述 → 更新 `## Scenes & Narrative` 添加三层结构或环境清晰度
  * 叙事结构 → 更新 `Narrative Structure` 选择和场景情绪弧线
  * 相机/构图 → 更新 `### Camera & Composition` 添加镜头类型/运动
  * 光照/色彩 → 更新 `### Lighting Style` 和 `### Color Palette & Grading`
  * 音频 → 更新 `## Audio & Music` 部分
  * 平台 → 更新 `### Platform Requirements` 添加具体平台和理由
  * 预算 → 更新 `### Budget & Timeline` 添加范围和权衡偏好
  * 边缘情况 → 在 `## Success Criteria` 下添加/修改或创建 `## Risk Mitigation` 小节
- 如果澄清使早期的模糊陈述失效，替换该陈述而不是重复；不留过时的矛盾文本
- 在每次集成后**保存规格文件**以最小化上下文丢失风险（原子覆盖）
- 保留格式：不重新排序不相关的部分；保持标题层次结构完整
- 保持每个插入的澄清最小且可测试（避免叙述偏离）

### 6. 验证（每次写入后执行加最终检查）

- Clarifications 会话每个接受的答案恰好包含一个项目符号（无重复）
- 总共提问（接受的）问题 ≤ 5
- 更新的部分不包含新答案应解决的模糊占位符
- 不存在矛盾的早期陈述（扫描现已无效的替代选择是否已删除）
- Markdown 结构有效；仅允许的新标题：`## Clarifications`, `### Session YYYY-MM-DD`
- 术语一致性：在所有更新部分中使用相同的规范术语
- 本次会话处理的所有 `[NEEDS CLARIFICATION]` 标记已从规格中**删除**

### 7. 将更新的规格写回 `FEATURE_SPEC`

### 8. 报告完成（提问循环结束或提前终止后）

- 提问和回答的问题数量
- 更新规格的路径
- 涉及的部分（列出名称）
- 覆盖度摘要表，列出每个分类体系类别及状态：
  * **已解决**（曾是部分/缺失，已处理）
  * **延期**（超出问题配额或更适合规划）
  * **明确**（已充分）
  * **未解决**（仍然部分/缺失但影响较低）
- 剩余 `[NEEDS CLARIFICATION]` 标记计数（应为 0 或非常少）
- 如果仍有未解决或延期的，建议是继续 `/plan` 还是稍后（计划后）再次运行 `/clarify`
- 建议的下一个命令：`/plan`（如果所有关键澄清已解决）

## 行为规则

- 如果未发现有意义的模糊性（或所有潜在问题影响都很低），回应："未检测到值得正式澄清的关键模糊性。所有主要方面都足够清晰。您可以继续 `/plan`。"并建议继续
- 如果规格文件缺失，指示用户首先运行 `/specify`（不在此处创建新规格）
- 永远不要超过 **5 个**总提问（单个问题的澄清重试不算作新问题）
- 避免推测性技术栈问题，除非缺失会阻碍功能清晰度（例如，唇形同步要求影响平台选择）
- 尊重用户的提前终止信号（"停止"、"完成"、"继续"）
- 如果由于完全覆盖而未提问，输出紧凑的覆盖度摘要（所有类别明确），然后建议推进
- 如果达到配额但仍有未解决的高影响类别，在"延期"下明确标记它们并附理由
- **MovieFlow 上下文**：在优先排序问题时应用 Constitution 原则（成本优先思维、规范优先、通过迭代保证质量）。预算/平台/角色一致性问题通常具有最高影响

优先级排序的上下文：{ARGS}
